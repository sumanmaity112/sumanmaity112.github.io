---
layout: post
title: How to manage RDS master password in Terraform
canonical_url: https://medium.com/@suman.maity112/how-to-manage-rds-master-password-in-terraform-f0ad431d4b75?source=rss-92eeb3145de9------2
tag:
- credentials
- rds
- terraform
- security
- state
---

<figure><img alt="" src="https://cdn-images-1.medium.com/max/412/1*4sAz3mDhHbQZGUwhi0NMSQ.png" /></figure><p><a href="https://developer.hashicorp.com/terraform">Terraform</a> is a popular tool for managing infrastructure as code. Terraform supports a variety of cloud provider plugins for seamless infrastructure management. Before we get into the problem statement, let’s look at how Terraform tracks infrastructure.</p><h3>Terraform State</h3><p><a href="https://developer.hashicorp.com/terraform/language/state">Terraform state</a> is a straightforward concept that stores the fundamental metadata required to refer to real-world infrastructure with the configuration. This terraform state also helps in performance optimization. Terraform state is stored in local by default as plain text in the file terraform.tfstate. This state file can also be stored remotely in an S3 bucket, which is appropriate for project team structure.</p><h3>Problem Statement</h3><p>As previously stated, Terraform saves all configurations in the Terraform state file as plain text. The issue arises when we want to keep sensitive data using Terraform. As an example, consider the creation of a new RDS cluster.</p><p>Let’s take a quick look at how to use Terraform to create an RDS cluster —</p><pre># rds.tf<br>resource &quot;aws_db_parameter_group&quot; &quot;default_13&quot; {<br>  name   = &quot;rds-pg-13&quot;<br>  family = &quot;aurora-postgresql13&quot;<br>  parameter {<br>    name  = &quot;log_min_duration_statement&quot;<br>    value = &quot;5000&quot;<br>  }<br>}<br><br>resource &quot;aws_rds_cluster_parameter_group&quot; &quot;default_13&quot; {<br>  name        = &quot;rds-cluster-pg-13&quot;<br>  family      = &quot;aurora-postgresql13&quot;<br>  description = &quot;RDS default cluster parameter group&quot;<br>}<br><br>module &quot;aurora-postgresql-rds&quot; {<br>  source = &quot;git@github.com:terraform-aws-modules/terraform-aws-rds-aurora?ref=v7.6.0&quot;<br><br>  name          = &quot;test-cluster&quot;<br>  database_name = &quot;test&quot;<br><br>  engine                      = &quot;aurora-postgresql&quot;<br>  engine_version              = &quot;13.4&quot;<br><br>  vpc_id  = &quot;vpc-12345678&quot;<br>  subnets = [&quot;subnet-12345678&quot;, &quot;subnet-87654321&quot;]<br><br>  iam_role_name            = &quot;rds-enhanced-monitoring-&quot;<br>  iam_role_use_name_prefix = true<br><br>  instance_class = &quot;db.r5.large&quot;<br><br>  storage_encrypted            = true<br>  apply_immediately            = true<br>  monitoring_interval          = 10<br>  performance_insights_enabled = true<br><br>  db_parameter_group_name                     = aws_db_parameter_group.default_13.name<br>  db_cluster_parameter_group_name             = aws_rds_cluster_parameter_group.default_13.name<br>  db_cluster_db_instance_parameter_group_name = aws_rds_cluster_parameter_group.default_13.name<br><br>  enabled_cloudwatch_logs_exports = [&quot;postgresql&quot;]<br><br>  create_random_password = true<br>  master_username        = &quot;test_user&quot;<br>}</pre><p>We’re putting together the aws_db_parameter_group and aws_rds_cluster_parameter_group required to set up an RDS cluster. The RDS module from terraform-aws-modules/terraform-aws-rds-aurora is then configured with some basic fields such as name, database_name, engine, master_username, and so on.</p><p>If we use terraform apply to apply the changes, it will create the test-cluster on AWS RDS with the username test-user and a random password. Everything is fine so far; now let’s look at the Terraform state file, which looks like this (with much more information) —</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*4p8h5bByclBIEnfdFfCfJA.png" /></figure><p>The password is stored in plain text if you see the highlighted lines above. Anyone who gains access to the state file will be able to access the database. This is a security issue. So, how do we address this concern?</p><h3>Solution</h3><p>To address the above concern, <a href="https://developer.hashicorp.com/terraform/language/state/sensitive-data">Terraform recommends</a> two options:</p><p>1. Utilize the <a href="https://cloud.hashicorp.com/products/terraform">Terraform Cloud</a>.<br>2. Encrypt the state file before storing it in a remote location.</p><p>Option 1 is a paid solution, and option 2 seems to be a viable alternative, but the problem persists when users download the state file to their local machine. So, how can we totally eradicate the security concerns?</p><p>We need to do something other than terraforming on a conceptual level. The simple solution is to change the password after the cluster is created. We can easily perform the manual update from the web console, but we have to repeat the process each time we deploy a new RDS cluster. So, how can we automate it?</p><p>We’ll use <a href="https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource">null_resource</a> with the aws cli command to automate it. The <a href="https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource">null_resource</a> implements the standard lifecycle but does nothing else.</p><p>Let’s include a script to rotate the RDS master password —</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/2ea8b1b93d812c1692d2958acbce6291/href">https://medium.com/media/2ea8b1b93d812c1692d2958acbce6291/href</a></iframe><p>First, we generate a random password of the specified length (<em>default 64 chars</em>). Once the random password is generated, we save the value to secrets manager so that we can securely access the secret later. The final step is to set the newly created password as the master password for the specified RDS cluster id.</p><blockquote>Note: It is entirely optional to generate a random password and store it in Secrets Manager. We can also pass specific passwords from outside.</blockquote><p>Now that our script is complete, let’s use null_resource to integrate it with Terraform —</p><pre>resource &quot;null_resource&quot; &quot;change_rds_password&quot; {<br>  triggers = {<br>    updated_count = 1<br>  }<br><br>  provisioner &quot;local-exec&quot; {<br>    working_dir = path.module<br>    command     = &quot;./rotate_rds_master_password.sh $rds_cluster_id $secret_id&quot;<br>    environment = {<br>      secret_id      = &quot;database_master_password&quot;<br>      rds_cluster_id = module.aurora-postgresql-rds.cluster_id<br>    }<br>  }<br>}</pre><p>In this case, we used <a href="https://developer.hashicorp.com/terraform/language/resources/provisioners/local-exec">local-exec</a> provisioner to execute the shell script that will rotate the password. The triggers attribute allows us to easily replace the resource when necessary, such as re-rotating the password.</p><blockquote>The executable permission for <em>rotate_rds_master_password.sh</em> is required. We used the script’s default password length (64) here, but a custom value can be provided. For easier access, we created a secret on the secret manager called <em>database_master_password</em>, which will contain the newly generated secret.</blockquote><p>Once we’ve completed the above steps, Terraform will automatically rotate passwords based on triggers.</p><p>With the above changes, Terraform State will still contain the old password, but it is no longer a security concern because the password no longer works.</p><h3>Final Thoughts</h3><p>With a few minor changes to our existing Terraform code, we were able to securely create an RDS cluster using Terraform. There are now three options for managing sensitive content, such as an RDS password —</p><ol><li>Utilize the <a href="https://cloud.hashicorp.com/products/terraform">Terraform Cloud</a>.</li><li>When storing the state file in Remote, encrypt it.</li><li>Use null_resource and the aws cli command to rotate the RDS password.</li></ol><p>You must decide which solution is best suited to your use case and team. However, it is recommended that sensitive data should be handled properly.</p><p><em>We focused on RDS here, but similar concepts can be applied to other databases.</em></p><blockquote>Note: To understand how to rotate the password for <a href="https://www.mongodb.com/home">MongoDB Atlas</a>, see <a href="https://gist.github.com/sumanmaity112/44b3d88ba8c600faaa57a8b4a131e424">this gist</a>.</blockquote><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=f0ad431d4b75" width="1" height="1" alt="">
